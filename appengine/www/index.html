<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<meta property="og:title" content="Shubz.TV"/>
	<meta property="og:type" content="video"/>
    <meta property="og:site_name" content="Shubz.TV"/>
	<title>Shubz.TV - Watch with your friends!</title>
	<link href="../styles/samples.css" type="text/css" rel="stylesheet">
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
	<script language="javascript" src="../scripts/jquery.juitter.js" type="text/javascript"></script>
	<script language="javascript" src="../scripts/system.js" type="text/javascript"></script>
	<script language="javascript" src="../scripts/yt.js" type="text/javascript"></script>
	<script src="http://staging.tokbox.com/v0.91/js/TB.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="http://connect.facebook.net/en_US/all.js"></script>
	<script type="text/javascript" charset="utf-8">
		var apiKey = 589411; // OpenTok sample API key. Replace with your own API key.
		var sessionId = '153975e9d3ecce1d11baddd2c9d8d3c9d147df18'; // Replace with your session ID.
		var token = 'devtoken'; // Should not be hard-coded.
								// Add to the page using the OpenTok server-side libraries.
		var session;
		var publisher;
		var subscribers = {};
        var DOC_URL = "/jdata";
        var playlist = [];
        var onair = 0;
        var DEFAULT_LIST = {
         "current": 0,
         "items":[
            {"id":"zkd5dJIVjgM","title":"Sesame Street: Smell Like A Monster","description":"Grover talks about the word \"on.\" Visit Grover on Facebook: on.fb.me If you're watching videos with your preschooler and would like to do so in a safe, child-friendly environment, please join us at www.sesamestreet.org Sesame Street is a production of Sesame Workshop, a nonprofit educational organization which also produces Pinky Dinky Doo, The Electric Company, and other programs for children around the world."},
            {"id":"3tI4CbCniBI","title":"Old Spice | Flex :30","description":"Welcome to the wildly powerful world of Odor Blocker Body Wash. I hope you're into explosions. Directed by Tim and Eric from the Awesome Show."},
            {"id":"Af1OxkFOK18","title":"Old Spice Commercial ft Bruce Campbell","description":"Old Spice commercial starring Bruce Campbell"}
          ]
        }

		// Un-comment either of the following to set automatic logging and exception handling.
		// See the exceptionHandler() method below.
		// TB.setLogLevel(TB.DEBUG);
		TB.addEventListener("exception", exceptionHandler);

		if (TB.checkSystemRequirements() != TB.HAS_REQUIREMENTS) {
			alert("You don't have the minimum requirements to run this application."
				  + "Please upgrade to the latest version of Flash.");
		} else {
			session = TB.initSession(sessionId);	// Initialize session

			// Add event listeners to the session
			session.addEventListener('sessionConnected', sessionConnectedHandler);
			session.addEventListener('sessionDisconnected', sessionDisconnectedHandler);
			session.addEventListener('connectionCreated', connectionCreatedHandler);
			session.addEventListener('connectionDestroyed', connectionDestroyedHandler);
			session.addEventListener('streamCreated', streamCreatedHandler);
			session.addEventListener('streamDestroyed', streamDestroyedHandler);
		}

		//--------------------------------------
		//  LINK CLICK HANDLERS
		//--------------------------------------

		/*
		If testing the app from the desktop, be sure to check the Flash Player Global Security setting
		to allow the page from communicating with SWF content loaded from the web. For more information,
		see http://www.tokbox.com/opentok/build/tutorials/helloworld.html#localTest
		*/
		function connect() {
			session.connect(apiKey, token);
		}

		function disconnect() {
			session.disconnect();
			hide('disconnectLink');
			hide('publishLink');
			hide('unpublishLink');
		}

		// Called when user wants to start publishing to the session
		function startPublishing() {
			if (!publisher) {
				var parentDiv = document.getElementById("myCamera");
				var publisherDiv = document.createElement('div'); // Create a div for the publisher to replace
				publisherDiv.setAttribute('id', 'opentok_publisher');
				parentDiv.appendChild(publisherDiv);
				publisher = session.publish(publisherDiv.id); // Pass the replacement div id to the publish method
				show('unpublishLink');
				hide('publishLink');
			}
		}

		function stopPublishing() {
			if (publisher) {
				session.unpublish(publisher);
			}
			publisher = null;

			show('publishLink');
			hide('unpublishLink');
		}

		//--------------------------------------
		//  OPENTOK EVENT HANDLERS
		//--------------------------------------

		function sessionConnectedHandler(event) {
			// Subscribe to all streams currently in the Session
			for (var i = 0; i < event.streams.length; i++) {
				addStream(event.streams[i]);
			}
			show('disconnectLink');
			show('publishLink');
			hide('connectLink');
		}

		function streamCreatedHandler(event) {
			// Subscribe to the newly created streams
			for (var i = 0; i < event.streams.length; i++) {
				addStream(event.streams[i]);
			}
		}

		function streamDestroyedHandler(event) {
			// This signals that a stream was destroyed. Any Subscribers will automatically be removed.
			// This default behaviour can be prevented using event.preventDefault()
		}

		function sessionDisconnectedHandler(event) {
			// This signals that the user was disconnected from the Session. Any subscribers and publishers
			// will automatically be removed. This default behaviour can be prevented using event.preventDefault()
			publisher = null;

			show('connectLink');
			hide('disconnectLink');
			hide('publishLink');
			hide('unpublishLink');
		}

		function connectionDestroyedHandler(event) {
			// This signals that connections were destroyed
		}

		function connectionCreatedHandler(event) {
			// This signals new connections have been created.
		}

		/*
		If you un-comment the call to TB.addEventListener("exception", exceptionHandler) above, OpenTok calls the
		exceptionHandler() method when exception events occur. You can modify this method to further process exception events.
		If you un-comment the call to TB.setLogLevel(), above, OpenTok automatically displays exception event messages.
		*/
		function exceptionHandler(event) {
			alert("Exception: " + event.code + "::" + event.message);
		}

		//--------------------------------------
		//  HELPER METHODS
		//--------------------------------------

		function addStream(stream) {
			// Check if this is the stream that I am publishing, and if so do not publish.
			if (stream.connection.connectionId == session.connection.connectionId) {
				return;
			}
			var subscriberDiv = document.createElement('div'); // Create a div for the subscriber to replace
			subscriberDiv.setAttribute('id', stream.streamId); // Give the replacement div the id of the stream as its id.
			document.getElementById("subscribers").appendChild(subscriberDiv);
			subscribers[stream.streamId] = session.subscribe(stream, subscriberDiv.id);
		}

		function show(id) {
			document.getElementById(id).style.display = 'inline';
		}

		function hide(id) {
			document.getElementById(id).style.display = 'none';
		}

    var Hashs = new function() {
      // <isEquals>
      // http://www.pageforest.com/lib/beta/js/pf-client.js : namespace.lookup('org.startpad.base')
      function generalType(o) {
        var t = typeof(o);
        if (t != 'object') {
            return t;
        }
        if (o instanceof String) {
            return 'string';
        }
        if (o instanceof Number) {
            return 'number';
        }
        return t;
      }

      function keys(map) {
        var list = [];

        for (var prop in map) {
            if (map.hasOwnProperty(prop)) {
                list.push(prop);
            }
        }
        return list;
      }

      /* Sort elements and remove duplicates from array (modified in place) */
      function uniqueArray(a) {
        if (!(a instanceof Array)) {
            return;
        }
        a.sort();
        for (var i = 1; i < a.length; i++) {
          if (a[i - 1] == a[i]) {
              a.splice(i, 1);
          }
        }
      }

      //Perform a deep comparison to check if two objects are equal.
      //Inspired by Underscore.js 1.1.0 - some semantics modifed.
      //Undefined properties are treated the same as un-set properties
      //in both Arrays and Objects.
      //Note that two objects with the same OWN properties can be equal
      //if they have different prototype chains (and inherited values).
      this.isEquals = function isEqual(a, b) {
        if (a === b) {
            return true;
        }
        if (generalType(a) != generalType(b)) {
            return false;
        }
        if (a == b) {
            return true;
        }
        if (typeof a != 'object') {
            return false;
        }
        // null != {}
        if (a instanceof Object != b instanceof Object) {
            return false;
        }

        if (a instanceof Date || b instanceof Date) {
            if (a instanceof Date != b instanceof Date ||
                a.getTime() != b.getTime()) {
                return false;
            }
        }

        var allKeys = [].concat(keys(a), keys(b));
        uniqueArray(allKeys);

        for (var i = 0; i < allKeys.length; i++) {
            var prop = allKeys[i];
            if (!isEqual(a[prop], b[prop])) {
                return false;
            }
        }
        return true;
      }
      // </isEquals>

      return this;
    };

    function parseSearch(q) {
      // Andy E and community @ http://stackoverflow.com/posts/2880929/revisions
      var results = {};
      var e,
          a = /\+/g,  // Regex for replacing addition symbol with a space
          r = /([^&=]+)=?([^&]*)/g,
          d = function (s) { return decodeURIComponent(s.replace(a, " ")); };

      while (e = r.exec(q)) {
         results[d(e[1])] = d(e[2]);
      }
      return results;
    };

    var items = {
      read: function(id, fn, err) {
        var url = DOC_URL + "/" + id;
        $.ajax({
          type: 'GET',
          url: url,
          dataType: 'json',
          beforeSend: function(xhr) {},
          success: function(data) {
            console.log("read succeded: " + JSON.stringify(data));
            fn(data);
          },
          error: function(request, textStatus, errorThrown) {
            // err
            var exception = {datasetname: 'madswvideo', status: request.status, message: request.statusText, url: url, method: "read", kind: textStatus};
            err(exception);
          }
        });
      },
      update: function(id, json, fn, err) {
        var url = DOC_URL + "/" + id;
        $.ajax({
          type: 'POST',
          url: url,
          data: json,
          dataType: 'json',
          beforeSend: function(xhr) {},
          success: fn,
          error: function(request, textStatus, errorThrown) {
            // err
            var exception = {datasetname: 'madswvideo', status: request.status, message: request.statusText, url: url, method: "update", kind: textStatus};
            err(exception);
          }
        });
      }
    }
    function read() {
       items.read(sessionId, function(list) {
          // fn
          if (!list || !list.current) {
             list = DEFAULT_LIST;
             items.update(sessionId, JSON.stringify(list), function() {
                console.warn("updated");
             }, function(exception) {
                console.warn(JSON.stringify(exception));
             });
           }
           if (!Hashs.isEquals(playlist, list.items)) {
              video_control.update_list(list.items);
              video_control.switch_video(list.current);
           } else if (!Hashs.isEquals(onair, list.current)) {
              video_control.switch_video(list.current);
           }

       }, function(exception) {
          console.warn(JSON.stringify(exception));
       });
    }
    function add_item(video_id) {
      var new_list = playlist.slice(0);
      new_list.push({id: video_id, title: "newly added: " + video_id});
      items.update(sessionId, JSON.stringify({items: new_list, current: onair}), function() {
        playlist = new_list;
        console.warn("updated list: " + list.length);
      }, function(exception) {
        console.warn(JSON.stringify(exception));
      });
    }
    function change_cursor(index) {
      items.update(sessionId, JSON.stringify({items: playlist, current: index}), function() {
        onair = index;
        console.warn("updated index: " + onair);
      }, function(exception) {
        console.warn(JSON.stringify(exception));
      });
    }
    $(document).ready(function() {
      var loc = window.location;
      var search = parseSearch(loc.hash.substring(1));
      if (search.session) {
        sessionId = search.session;
      }

      read();
      setTimeout(function() {
         read();
      },
      10000);
    });
	</script>
</head>
<body>

<div id="body">
	<table><tr><td>
		<div id="header">
			<h1>Shubz.TV</h1>
			<div id="instructions">
				Hey, what should I do?
				<ol>
					<li>Enter to the room:
		       	<input type="button" value="Yo!" id ="connectLink" style="display: foo" onClick="javascript:connect()" />
		       	<input type="button" value="I'm out!" id ="disconnectLink" onClick="javascript:disconnect()" />
					</li>
					<li>Activate your camera:
		       	<input type="button" value="Action!" id ="publishLink" onClick="javascript:startPublishing()" />
		       	<input type="button" value="That's a wrap!" id ="unpublishLink" onClick="javascript:stopPublishing()" />
					</li>
					<li>Watch with friends!</li>
				</ol>
			</div>
		</div>
		<div id="chat">
	   	   <div id="myCamera" class="publisherContainer"></div>
		   <div id="subscribers"></div>
			<div id="opentok_console"></div>
		</div>
	</td><td>
		<div id="video">
		  <script type="text/javascript" src="../scripts/swfobject.js"></script>
		  <div id="ytapiplayer">
		    You need Flash player 8+ and JavaScript enabled to view this video.
		  </div>

		  <script type="text/javascript">

		    var params = { allowScriptAccess: "always" };
		    var atts = { id: "myytplayer" };
		    swfobject.embedSWF("http://www.youtube.com/apiplayer?enablejsapi=1&playerapiid=ytplayer",
		                       "ytapiplayer", "640", "385", "8", null, null, params, atts);

		  </script>
		</div>
		<div id="videochooser">
			<ol id="videolist">
				<li>Loading Videos...</li>
			</ol>
		</div>
		<div id="juitterContainer"></div>
	</tr>
	</table>
</div>
<script>
	// this is what triggers the video chat service to start
	show('connectLink');
</script>


       <div id="fb-root"></div>

       	 <div id="fbLoginDiv" >
	    <fb:login-button perms="user_videos, xmpp_login, publish_stream" autologoutlink="true" onlogin="OnToggleLogin()">
        </fb:login-button>
        </div>

	    <div id="fbLogoutDiv" style="display:none">
        </div>

        <div id="fbInviteDiv" style="display:none">
        <!--
        <fb:send id="fbSendLink" ref="shubz.tv" href=document.URL + "#session=" + sessionId></fb:send>
        //-->
        <a href="javascript:InviteFriends()">Invite friends</a>
        </div>





      <script>
         FB.init({
            appId:'8796512710', cookie:true,
            status:true, xfbml:true
         });

        var loginDiv = document.getElementById("fbLoginDiv");
        var logoutDiv = document.getElementById("fbLogoutDiv");
        var inviteDiv = document.getElementById("fbInviteDiv");

        FB.getLoginStatus(function(response) {
            if (response.session) {
        		loginDiv.style.display = "none";
        		logoutDiv.style.display = "block";
        		inviteDiv.style.display = "block";
	        }else {
        		loginDiv.style.display = "block";
        		logoutDiv.style.display = "none";
        		inviteDiv.style.display = "none";
        	}
        });

        function InviteFriends()
        {

            FB.ui({method: 'send', message: 'Come watch this awesome video with me:' + document.URL + "#session="+ sessionId});

        }

        function OnToggleLogin()
        {

            loginDiv.style.display = "none";
        	logoutDiv.style.display = "block";
        	inviteDiv.style.display = "block";
        }

      </script>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-23056696-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</body>
</html>
